<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - E-commerce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-color: #6366f1;
        --accent-color: #ef4444;
        --text-dark: #111827;
        --text-body: #374151;
      }
      body {
        font-family: 'Inter', sans-serif;
        color: var(--text-body);
        background-color: #f9fafb;
      }
      h4, h5 {
        font-family: 'Poppins', sans-serif;
        color: var(--text-dark);
      }
      .notification-container {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1050;
      }
      .scale-0 {
        transform: scale(0);
      }
      .scale-100 {
        transform: scale(1);
      }
      .checkout-btn {
        background-color: var(--accent-color);
      }
      .checkout-btn:hover {
        background-color: #c93b3b;
      }
    </style>
  </head>
  <body class="bg-gray-50 flex flex-col min-h-screen">
    <div id="navbar-placeholder"></div>

    <div class="container mx-auto px-4 py-12 max-w-7xl flex-grow">
      <div class="flex flex-col lg:flex-row gap-8">
        <div class="w-full lg:w-7/12">
          <div class="bg-white border border-gray-100 rounded-2xl p-8 shadow-lg">
            <h4 class="text-2xl font-bold mb-6 border-b pb-4">Shipping Information</h4>
            <form id="shipping-form" class="space-y-5" novalidate>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="space-y-2">
                  <label for="firstName" class="block text-sm font-medium text-gray-700">First name</label>
                  <input
                    type="text"
                    id="firstName"
                    placeholder="Ali"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150"
                    required
                  />
                  <div class="text-red-600 text-sm hidden" id="firstName-error">
                    First name is required.
                  </div>
                </div>
                <div class="space-y-2">
                  <label for="lastName" class="block text-sm font-medium text-gray-700">Last name</label>
                  <input
                    type="text"
                    id="lastName"
                    placeholder="Aliyev"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150"
                    required
                  />
                  <div class="text-red-600 text-sm hidden" id="lastName-error">
                    Last name is required.
                  </div>
                </div>
              </div>

              <div class="space-y-2">
                <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                <input
                  type="text"
                  id="city"
                  placeholder="Baku"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150"
                  required
                />
                <div class="text-red-600 text-sm hidden" id="city-error">
                  City is required.
                </div>
              </div>

              <div class="space-y-2">
                <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                <input
                  type="text"
                  id="address"
                  placeholder="Street, House/Apartment"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150"
                  required
                />
                <div class="text-red-600 text-sm hidden" id="address-error">
                  Address is required.
                </div>
              </div>

              <div class="space-y-2">
                <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                <input
                  type="tel"
                  id="phone"
                  placeholder="+994 xx xxx xx xx"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150"
                  required
                />
                <div class="text-red-600 text-sm hidden" id="phone-error">
                  Phone number is required.
                </div>
              </div>

              <div class="flex items-start pt-2">
                <div class="flex items-center h-5">
                  <input
                    type="checkbox"
                    id="termsCheck"
                    class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                    required
                  />
                </div>
                <div class="ml-3 text-sm">
                  <label for="termsCheck" class="font-medium text-gray-700 cursor-pointer"
                    >I agree to the terms and conditions</label
                  >
                  <div class="text-red-600 text-sm hidden" id="terms-error">
                    You must agree before submitting.
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="w-full lg:w-5/12 space-y-6">
          <div class="bg-white border border-gray-100 rounded-2xl p-8 shadow-lg">
            <h5 class="text-xl font-bold mb-4 text-gray-800">Order Summary</h5>
            
            <div class="mb-4 p-3 bg-gray-50 rounded border border-gray-200">
                <p class="text-sm text-gray-500">Your Wallet Balance:</p>
                <p class="text-lg font-bold text-indigo-600" id="user-balance-display">0.00 â‚¼</p>
            </div>

            <div class="space-y-3 text-gray-600">
              <div class="flex justify-between">
                <span>Subtotal</span>
                <span id="subtotal" class="font-medium text-gray-900">0 â‚¼</span>
              </div>
              <div class="flex justify-between">
                <span>Shipping</span>
                <span class="text-green-600 font-medium">Free</span>
              </div>
              <hr class="my-3 border-gray-200" />
              <div class="flex justify-between font-bold text-lg text-gray-900">
                <span>Total</span>
                <span id="total">0 â‚¼</span>
              </div>
            </div>
            <button
              id="placeOrderBtn"
              class="w-full checkout-btn text-white py-3 px-6 rounded-lg font-bold shadow-md hover:shadow-lg transition duration-300 mt-6 flex justify-center items-center"
            >
              Pay with Wallet <i class="fas fa-wallet ml-2"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="notification-container">
      <div
        id="success-alert"
        class="bg-green-500 text-white px-4 py-3 rounded shadow-md flex justify-between items-center transform transition-transform duration-300 scale-0"
      >
        <div>Order placed successfully! Redirecting...</div>
        <button
          type="button"
          class="focus:outline-none ml-4"
          onclick="closeNotification()"
        >
          <span class="text-2xl">&times;</span>
        </button>
      </div>
    </div>

    <script>
      function validateForm(formId) {
        const form = document.getElementById(formId);
        const inputs = form.querySelectorAll("input[required]");
        let isValid = true;

        inputs.forEach((input) => {
          const errorId = input.id + "-error";
          const errorElement = document.getElementById(errorId);

          if (!input.checkValidity()) {
            input.classList.add("border-red-500");
            input.classList.remove("focus:border-indigo-500");
            if (errorElement) errorElement.classList.remove("hidden");
            isValid = false;
          } else {
            input.classList.remove("border-red-500");
            input.classList.add("focus:border-indigo-500");
            if (errorElement) errorElement.classList.add("hidden");
          }
        });

        return isValid;
      }

      function showNotification() {
        const alert = document.getElementById("success-alert");
        alert.classList.remove("scale-0");
        alert.classList.add("scale-100");

        setTimeout(() => {
          closeNotification();
        }, 5000);
      }

      function closeNotification() {
        const alert = document.getElementById("success-alert");
        alert.classList.remove("scale-100");
        alert.classList.add("scale-0");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const shippingForm = document.getElementById("shipping-form");

        const allInputs = document.querySelectorAll("input[required]");
        allInputs.forEach((input) => {
          input.addEventListener("input", function () {
            const errorId = input.id + "-error";
            const errorElement = document.getElementById(errorId);

            if (input.checkValidity()) {
              input.classList.remove("border-red-500");
              input.classList.add("focus:border-indigo-500");
              if (errorElement) errorElement.classList.add("hidden");
            }
          });
        });

        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        let subtotal = cart.reduce(
          (acc, item) => acc + item.price * item.quantity,
          0
        );
        
        let currentBalance = parseFloat(localStorage.getItem("userBalance")) || 0;

        document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " â‚¼";
        document.getElementById("total").textContent = subtotal.toFixed(2) + " â‚¼";
        document.getElementById("user-balance-display").textContent = currentBalance.toFixed(2) + " â‚¼";

        document
          .getElementById("placeOrderBtn")
          .addEventListener("click", function () {
            if (cart.length === 0) {
              alert("Your cart is empty!");
              return;
            }

            const isShippingValid = validateForm("shipping-form");

            if (isShippingValid) {
              if (currentBalance >= subtotal) {
                  const cashbackPercent = Math.random() * 5; 
                  const cashbackAmount = subtotal * (cashbackPercent / 100);
                  
                  let newBalance = currentBalance - subtotal + cashbackAmount; 

                  localStorage.setItem("userBalance", newBalance);

                  alert(`TÉ™briklÉ™r! SifariÅŸiniz (${subtotal.toFixed(2)} â‚¼) uÄŸurla Ã¶dÉ™nildi. \n\n ðŸŽ‰ Cashback: ${cashbackPercent.toFixed(2)}% (${cashbackAmount.toFixed(2)} â‚¼) hesabÄ±nÄ±za geri qaytarÄ±ldÄ±!`);
                  
                  showNotification();
                  localStorage.removeItem("cart");
                  setTimeout(() => (window.location.href = "index.html"), 2000);
              } else {
                  alert(`Insufficient funds! You have ${currentBalance.toFixed(2)} â‚¼, but order total is ${subtotal.toFixed(2)} â‚¼. Please top up your wallet.`);
              }
            }
          });
      });
    </script>

    <script src="navbar.js"></script>
    <script
      src="https://kit.fontawesome.com/558b0d9e50.js"
      crossorigin="anonymous"
    ></script>
    <script src="footer.js"></script>
  </body>
</html>