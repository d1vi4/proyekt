<script>
  const PROMO_CODES = {
    "ELXANCOOL": 0.50, "ECOMMERCE": 0.10, "DEC15%": 0.15, "SKIDKA": 0.20, "ENDIRIM10": 0.10
  };
  const MAX_USAGE = 3;
  let currentDiscount = 0;
  let appliedCode = null;
  let user = JSON.parse(localStorage.getItem("loggedInUser"));

  function getPromoUsage(code) {
    const usageData = JSON.parse(localStorage.getItem('promoUsage')) || {};
    return usageData[code] || 0;
  }

  function incrementPromoUsage(code) {
    const usageData = JSON.parse(localStorage.getItem('promoUsage')) || {};
    usageData[code] = (usageData[code] || 0) + 1;
    localStorage.setItem('promoUsage', JSON.stringify(usageData));
  }

  function addTransaction(type, amount) {
    if (!user) return;
    const USER_TRANSACTIONS_KEY = 'transactions_' + user.username;
    
    const transactions = JSON.parse(localStorage.getItem(USER_TRANSACTIONS_KEY)) || [];
    const newTx = { id: Date.now(), type: type, amount: amount, date: new Date().toLocaleString('az-AZ') };
    transactions.unshift(newTx);
    localStorage.setItem(USER_TRANSACTIONS_KEY, JSON.stringify(transactions));
  }

  function validateForm(formId) {
    const form = document.getElementById(formId);
    const inputs = form.querySelectorAll("input[required]");
    let isValid = true;
    inputs.forEach((input) => {
       if (!input.value.trim()) {
         input.classList.add("border-red-500");
         isValid = false;
       } else {
         input.classList.remove("border-red-500");
       }
    });
    return isValid;
  }

  document.addEventListener("DOMContentLoaded", function () {
    if (!user) { window.location.href = "login.html"; return; }
    
    const USER_BALANCE_KEY = "userBalance_" + user.username;

    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
    let currentBalance = parseFloat(localStorage.getItem(USER_BALANCE_KEY)) || 0;

    function updateTotal() {
        const discountValue = subtotal * currentDiscount;
        const finalTotal = subtotal - discountValue;
        document.getElementById("subtotal").textContent = subtotal.toFixed(2) + " ₼";
        document.getElementById("discount-amount").textContent = "-" + discountValue.toFixed(2) + " ₼";
        document.getElementById("total").textContent = finalTotal.toFixed(2) + " ₼";
        if(currentDiscount > 0) document.getElementById("discount-row").classList.remove("hidden");
        else document.getElementById("discount-row").classList.add("hidden");
        return finalTotal;
    }

    updateTotal();
    document.getElementById("user-balance-display").textContent = currentBalance.toFixed(2) + " ₼";

    document.getElementById("apply-promo-btn").addEventListener("click", function() {
        const codeInput = document.getElementById("promo-code-input");
        const messageEl = document.getElementById("promo-message");
        const code = codeInput.value.trim().toUpperCase();
        if (!code) return;

        if (PROMO_CODES.hasOwnProperty(code)) {
        }


        const oneTimeCodes = JSON.parse(localStorage.getItem(`oneTimePromoCodes_${user.username}`)) || {};
        if (oneTimeCodes.hasOwnProperty(code) && !oneTimeCodes[code].used) {
            currentDiscount = oneTimeCodes[code].discount;
            appliedCode = { code: code, type: 'onetime' };
            messageEl.className = "text-xs font-medium text-green-600";
            messageEl.textContent = `Uğurlu! ${oneTimeCodes[code].discount * 100}% endirim tətbiq edildi. (Taleh Çarxı)`;
            updateTotal();
            return;
        }

        messageEl.className = "text-xs font-medium text-red-600";
        messageEl.textContent = "Yanlış kod.";
    });

    document.getElementById("placeOrderBtn").addEventListener("click", function () {
        if (cart.length === 0) { alert("Səbət boşdur!"); return; }
        if (!validateForm("shipping-form")) return;
        
        const finalTotal = updateTotal();

        if (currentBalance >= finalTotal) {
            const cashbackPercent = Math.random() * 5; 
            const cashbackAmount = finalTotal * (cashbackPercent / 100);
            let newBalance = currentBalance - finalTotal + cashbackAmount; 
            
            const orderId = "ORD-" + Math.floor(10000 + Math.random() * 90000);
            
            const orderData = {
                id: orderId,
                date: Date.now(),
                items: cart,
                total: finalTotal,
                status: "Processing"
            };
            
            let allOrders = JSON.parse(localStorage.getItem("allOrders")) || {};
            allOrders[orderId] = orderData;
            localStorage.setItem("allOrders", JSON.stringify(allOrders));

            if (user) {
                let myOrders = JSON.parse(localStorage.getItem("myOrders_" + user.username)) || [];
                myOrders.unshift(orderData);
                localStorage.setItem("myOrders_" + user.username, JSON.stringify(myOrders));
            }
            localStorage.setItem(USER_BALANCE_KEY, newBalance);
            
            if (appliedCode) {
            }

            addTransaction("Alış", -finalTotal);
            addTransaction("Kəşbək", cashbackAmount);

        } else {
            alert("Balansınızda yetərli vəsait yoxdur! Zəhmət olmasa balansı artırın.");
        }
    });
  });
</script>